<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Advanced Filter Panel */
        .filter-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(20, 30, 40, 0.95);
            color: white;
            padding: 15px;
            border-radius: 10px;
            width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 1000;
            font-size: 14px;
        }
        
        .filter-panel h3 {
            margin: 0 0 15px 0;
            color: #3498db;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .filter-section {
            margin-bottom: 20px;
        }
        
        .filter-section h4 {
            margin: 0 0 10px 0;
            color: #ecf0f1;
            font-size: 13px;
            text-transform: uppercase;
        }
        
        .filter-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        .filter-checkbox:hover {
            background: rgba(52, 152, 219, 0.2);
        }
        
        .filter-checkbox input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        .filter-checkbox .symbol {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border: 2px solid white;
        }
        
        .symbol.circle {
            border-radius: 50%;
        }
        
        .symbol.diamond {
            transform: rotate(45deg);
        }
        
        .symbol.triangle {
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 16px solid;
            border-top: none;
            margin-right: 12px;
        }
        
        .risk-color-box {
            width: 20px;
            height: 15px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
        
        /* Beautiful popup styling */
        .leaflet-popup-content-wrapper {
            background: rgba(30, 40, 50, 0.95);
            color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .leaflet-popup-content {
            margin: 15px;
        }
        
        .leaflet-popup-content table {
            background: transparent;
            border-collapse: collapse;
            width: 100%;
        }
        
        .leaflet-popup-content th {
            background: rgba(52, 152, 219, 0.8);
            color: white;
            padding: 8px;
            font-weight: bold;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .leaflet-popup-content td {
            background: rgba(40, 50, 60, 0.8);
            color: #ffffff;
            padding: 8px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .heritage-title {
            background: rgba(231, 76, 60, 0.9) !important;
            color: white !important;
            font-weight: bold;
            text-align: center;
        }
        
        .risk-score {
            background: rgba(230, 126, 34, 0.9) !important;
            color: white !important;
            font-weight: bold;
        }
        
        /* Toggle button for filter panel */
        .filter-toggle {
            position: absolute;
            top: 60px;
            right: 10px;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            font-size: 14px;
        }
        
        .filter-toggle:hover {
            background: rgba(41, 128, 185, 1);
        }
        
        /* Data Status Panel */
        .data-status {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(20, 30, 40, 0.95);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }
        
        /* Loading indicator */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 10000;
            display: none;
        }
        </style>
        <title>Avalia√ß√£o de Risco dos Bens Culturais do Brasil - Mapa Interativo</title>
    </head>
    <body>
        <div id="map"></div>
        
        <!-- Filter Toggle Button -->
        <button class="filter-toggle" onclick="toggleFilterPanel()">üîß Filtros</button>
        
        <!-- Advanced Filter Panel -->
        <div class="filter-panel" id="filterPanel">
            <h3>üéØ Filtros do Mapa</h3>
            
            <!-- Heritage Type Filter -->
            <div class="filter-section">
                <h4>üèõÔ∏è Bem Cultural Material</h4>
                <div class="filter-checkbox" onclick="toggleHeritageFilter('immovable')">
                    <input type="checkbox" id="heritage_immovable" checked>
                    <div class="symbol circle" style="background-color: #27ae60;"></div>
                    <span>Bens Im√≥veis</span>
                </div>
                <div class="filter-checkbox" onclick="toggleHeritageFilter('movable')">
                    <input type="checkbox" id="heritage_movable" checked>
                    <div class="symbol diamond" style="background-color: #3498db;"></div>
                    <span>Bens M√≥veis ou integrados</span>
                </div>
            </div>
            
            <!-- Risk Type Filter - UPDATED WITH HYDROLOGICAL RISK -->
            <div class="filter-section">
                <h4>üî• Riscos</h4>
                <div class="filter-checkbox" onclick="toggleRiskTypeFilter('dam')">
                    <input type="checkbox" id="risk_type_dam" checked>
                    <div class="risk-color-box" style="background-color: #e77148;"></div>
                    <span>Desastre Tecnol√≥gico</span>
                </div>
                <div class="filter-checkbox" onclick="toggleRiskTypeFilter('fire')">
                    <input type="checkbox" id="risk_type_fire" checked>
                    <div class="risk-color-box" style="background-color: #e74c3c;"></div>
                    <span>Inc√™ndio Florestal</span>
                </div>
                <div class="filter-checkbox" onclick="toggleRiskTypeFilter('geological')">
                    <input type="checkbox" id="risk_type_geological" checked>
                    <div class="risk-color-box" style="background-color: #8e44ad;"></div>
                    <span>Movimento de Massa</span>
                </div>
                <div class="filter-checkbox" onclick="toggleRiskTypeFilter('hydrological')">
                    <input type="checkbox" id="risk_type_hydrological" checked>
                    <div class="risk-color-box" style="background-color: #2980b9;"></div>
                    <span>Inunda√ß√µes, Enxurradas e Alagamentos</span>
                </div>
            </div>
            
            <!-- Layer Visibility -->
            <div class="filter-section">
                <h4>üó∫Ô∏è Camadas do Mapa</h4>
                <div class="filter-checkbox" onclick="toggleLayer('heritage')">
                    <input type="checkbox" id="layer_heritage" checked>
                    <span>üèõÔ∏è Bens Culturais Materiais Protegidos</span>
                </div>
                <div class="filter-checkbox" onclick="toggleLayer('dam_buffers')">
                    <input type="checkbox" id="layer_dam_buffers" checked>
                    <span>üèóÔ∏è Barragens Potencialmente Perigosas</span>
                </div>
                <div class="filter-checkbox" onclick="toggleLayer('municipal_risk')">
                    <input type="checkbox" id="layer_municipal_risk" checked>
                    <span>üéØ Cloropl√©tico Municipal</span>
                </div>
                <div class="filter-checkbox" onclick="toggleLayer('municipal_boundaries')">
                    <input type="checkbox" id="layer_municipal_boundaries" checked>
                    <span>üó∫Ô∏è Limites Municipais</span>
                </div>
            </div>
            
            <!-- Filter Actions -->
            <div class="filter-section">
                <button onclick="resetAllFilters()" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; width: 100%; margin-bottom: 5px;">Resetar Todos os Filtros</button>
                <button onclick="showAllLayers()" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; width: 100%;">Mostrar Todas as Camadas</button>
            </div>
        </div>
        
        <!-- Data Status Panel -->
        <div class="data-status" id="dataStatus">
            <div><strong>üìä Status dos Dados:</strong></div>
            <div id="heritageCount">S√≠tios de Bens Culturais: Carregando...</div>
            <div id="damCount">Zonas de Barragens: Carregando...</div>
            <div id="municipalCount">Munic√≠pios: Carregando...</div>
            <div id="riskCount">√Åreas de Risco: Carregando...</div>
        </div>
        
        <div class="loading-indicator" id="loadingIndicator">
            <h3>Carregando Avalia√ß√£o de Risco dos Bens Culturais...</h3>
            <div>Inicializando camadas do mapa e dados...</div>
        </div>
        
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/multi-style-layer.js"></script>
        <script src="js/leaflet-svg-shape-markers.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="data/municipalities_1_simplified_1.js"></script>
        <script src="data/municipalities_with_combined_risk_simplified_2.js"></script>
        <script src="data/snisb_dam_buffers_3.js"></script>
        <script src="data/comprehensive_heritage_risk_4.js"></script>
        
        <script>
        // Show loading indicator
        document.getElementById('loadingIndicator').style.display = 'block';
        
        // Global variables for layers and filtering
        var map;
        var allLayers = {};
        var filters = {
            heritage: {
                immovable: true,
                movable: true
            },
            risk: {
                medium: true,
                high: true,
                very_high: true
            },
            riskType: {
                dam: true,
                fire: true,
                geological: true,
                hydrological: true
            },
            layers: {
                heritage: true,
                dam_buffers: true,
                municipal_risk: true,
                municipal_boundaries: true
            }
        };
        
        // Data validation and status tracking
        var dataStatus = {
            heritage: 0,
            dams: 0,
            municipalities: 0,
            riskAreas: 0
        };
        
        // Check if data is loaded and update status
        function checkDataStatus() {
            // Check heritage data
            if (typeof json_comprehensive_heritage_risk_4 !== 'undefined' && json_comprehensive_heritage_risk_4.features) {
                dataStatus.heritage = json_comprehensive_heritage_risk_4.features.length;
                document.getElementById('heritageCount').innerHTML = 'üèõÔ∏è Bens Culturais Materiais Protegidos: ' + dataStatus.heritage;
            } else {
                document.getElementById('heritageCount').innerHTML = 'üèõÔ∏è Bens Culturais Materiais Protegidos: ‚ùå Falha ao carregar';
            }
            
            // Check dam data
            if (typeof json_snisb_dam_buffers_3 !== 'undefined' && json_snisb_dam_buffers_3.features) {
                dataStatus.dams = json_snisb_dam_buffers_3.features.length;
                document.getElementById('damCount').innerHTML = 'üèóÔ∏è Barragens Potencialmente Perigosas: ' + dataStatus.dams;
            } else {
                document.getElementById('damCount').innerHTML = 'üèóÔ∏è Barragens Potencialmente Perigosas: ‚ùå Falha ao carregar';
            }
            
            // Check municipal boundaries
            if (typeof json_municipalities_1_simplified_1 !== 'undefined' && json_municipalities_1_simplified_1.features) {
                dataStatus.municipalities = json_municipalities_1_simplified_1.features.length;
                document.getElementById('municipalCount').innerHTML = 'üó∫Ô∏è Limites Municipais: ' + dataStatus.municipalities;
            } else {
                document.getElementById('municipalCount').innerHTML = 'üó∫Ô∏è Limites Municipais: ‚ùå Falha ao carregar';
            }
            
            // Check risk areas
            if (typeof json_municipalities_with_combined_risk_simplified_2 !== 'undefined' && json_municipalities_with_combined_risk_simplified_2.features) {
                dataStatus.riskAreas = json_municipalities_with_combined_risk_simplified_2.features.length;
                document.getElementById('riskCount').innerHTML = 'üéØ Cloropl√©tico Municipal: ' + dataStatus.riskAreas;
            } else {
                document.getElementById('riskCount').innerHTML = 'üéØ Cloropl√©tico Municipal: ‚ùå Falha ao carregar';
            }
        }
        
        // Filter Panel Toggle
        function toggleFilterPanel() {
            var panel = document.getElementById('filterPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        // Heritage Type Filtering
        function toggleHeritageFilter(type) {
            filters.heritage[type] = !filters.heritage[type];
            document.getElementById('heritage_' + type).checked = filters.heritage[type];
            applyHeritageFilters();
        }
        
        // Risk Level Filtering
        function toggleRiskFilter(level) {
            filters.risk[level] = !filters.risk[level];
            document.getElementById('risk_' + level).checked = filters.risk[level];
            applyRiskFilters();
        }
        
        // Risk Type Filtering - NEW FUNCTIONALITY
        function toggleRiskTypeFilter(type) {
            filters.riskType[type] = !filters.riskType[type];
            document.getElementById('risk_type_' + type).checked = filters.riskType[type];
            applyRiskTypeFilters();
        }
        
        // Layer Visibility Toggle
        function toggleLayer(layerName) {
            filters.layers[layerName] = !filters.layers[layerName];
            document.getElementById('layer_' + layerName).checked = filters.layers[layerName];
            
            var layer = allLayers[layerName];
            if (layer) {
                if (filters.layers[layerName]) {
                    map.addLayer(layer);
                } else {
                    map.removeLayer(layer);
                }
            }
        }
        
        // Apply Heritage Filters
        function applyHeritageFilters() {
            if (allLayers.heritage) {
                allLayers.heritage.eachLayer(function(layer) {
                    var nature = String(layer.feature.properties['ds_natureza'] || '');
                    var show = false;
                    
                    if (nature.includes('Im√≥vel') && filters.heritage.immovable) show = true;
                    if (nature.includes('M√≥vel') && filters.heritage.movable) show = true;
                    
                    // If neither immovable nor movable filter is selected, hide all
                    if (!filters.heritage.immovable && !filters.heritage.movable) {
                        show = false;
                    }
                    
                    if (show) {
                        layer.setStyle({opacity: 1, fillOpacity: 0.8});
                    } else {
                        layer.setStyle({opacity: 0, fillOpacity: 0});
                    }
                });
            }
        }
        
        // Apply Risk Level Filters
        function applyRiskFilters() {
            if (allLayers.heritage) {
                allLayers.heritage.eachLayer(function(layer) {
                    var riskScore = layer.feature.properties['comprehensive_risk_score'];
                    var show = false;
                    
                    if (riskScore <= 0.72 && filters.risk.medium) show = true;
                    else if (riskScore > 0.72 && riskScore <= 1.5 && filters.risk.high) show = true;
                    else if (riskScore > 1.5 && filters.risk.very_high) show = true;
                    
                    if (show) {
                        layer.setStyle({opacity: 1, fillOpacity: 0.8});
                    } else {
                        layer.setStyle({opacity: 0, fillOpacity: 0});
                    }
                });
            }
        }
        
        // Apply Risk Type Filters - UPDATED WITH HYDROLOGICAL RISK
        function applyRiskTypeFilters() {
            if (allLayers.heritage) {
                allLayers.heritage.eachLayer(function(layer) {
                    var damRisk = layer.feature.properties['dam_risk_score'] || 0;
                    var fireRisk = layer.feature.properties['fire_risk_score'] || 0;
                    var cemRisk = layer.feature.properties['cemaden_risk_score'] || 0;
                    var show = false;
                    
                    // Show if any selected risk type is present (score > 0)
                    if (filters.riskType.dam && damRisk > 0) show = true;
                    if (filters.riskType.fire && fireRisk > 0) show = true;
                    if (filters.riskType.geological && cemRisk > 0) show = true;
                    if (filters.riskType.hydrological && cemRisk > 0) show = true; // CEMADEN includes hydrological data
                    
                    // If no risk types are selected, show all
                    if (!filters.riskType.dam && !filters.riskType.fire && !filters.riskType.geological && !filters.riskType.hydrological) {
                        show = true;
                    }
                    
                    if (show) {
                        layer.setStyle({opacity: 1, fillOpacity: 0.8});
                    } else {
                        layer.setStyle({opacity: 0, fillOpacity: 0});
                    }
                });
            }
        }
        
        // Reset All Filters
        function resetAllFilters() {
            // Reset all filter states
            for (var category in filters) {
                for (var item in filters[category]) {
                    filters[category][item] = false;
                    var checkbox = document.getElementById(category + '_' + item) || 
                                 document.getElementById('heritage_' + item) || 
                                 document.getElementById('risk_' + item) ||
                                 document.getElementById('risk_type_' + item) ||
                                 document.getElementById('layer_' + item);
                    if (checkbox) checkbox.checked = false;
                }
            }
            
            // Hide all layers
            for (var layerName in allLayers) {
                if (allLayers[layerName] && map.hasLayer(allLayers[layerName])) {
                    map.removeLayer(allLayers[layerName]);
                }
            }
        }
        
        // Show All Layers
        function showAllLayers() {
            // Enable all filters
            for (var category in filters) {
                for (var item in filters[category]) {
                    filters[category][item] = true;
                    var checkbox = document.getElementById(category + '_' + item) || 
                                 document.getElementById('heritage_' + item) || 
                                 document.getElementById('risk_' + item) ||
                                 document.getElementById('risk_type_' + item) ||
                                 document.getElementById('layer_' + item);
                    if (checkbox) checkbox.checked = true;
                }
            }
            
            // Show all layers
            for (var layerName in allLayers) {
                if (allLayers[layerName] && !map.hasLayer(allLayers[layerName])) {
                    map.addLayer(allLayers[layerName]);
                }
            }
            
            // Reapply filters
            applyHeritageFilters();
            applyRiskFilters();
            applyRiskTypeFilters();
        }
        
        var highlightLayer;
        function highlightFeature(e) {
            highlightLayer = e.target;
            highlightLayer.openPopup();
        }
        
        map = L.map('map', {
            zoomControl: false, 
            maxZoom: 28, 
            minZoom: 1
        });
        
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

        // Enhanced popup content removal
        function removeEmptyRowsFromPopupContent(content, feature) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var rows = tempDiv.querySelectorAll('tr');
            for (var i = 0; i < rows.length; i++) {
                var td = rows[i].querySelector('td.visible-with-data');
                var key = td ? td.id : '';
                if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                    rows[i].parentNode.removeChild(rows[i]);
                }
            }
            return tempDiv.innerHTML;
        }

        // Enhanced media popup class
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            if (tempDiv.querySelector('td img')) {
                popup._contentNode.classList.add('media');
                setTimeout(function() {
                    popup.update();
                }, 10);
            } else {
                popup._contentNode.classList.remove('media');
            }
        }

        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);

        var measureControl = new L.Control.Measure({
            position: 'topleft',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares'
        });
        measureControl.addTo(map);
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';

        var bounds_group = new L.featureGroup([]);
        function setBounds() {
            if (bounds_group.getLayers().length) {
                map.fitBounds(bounds_group.getBounds());
            }
        }

        // Base layer
        map.createPane('pane_OpenStreetMap_0');
        map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
        var layer_OpenStreetMap_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OpenStreetMap_0',
            opacity: 0.35,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_OpenStreetMap_0;
        map.addLayer(layer_OpenStreetMap_0);

        // Municipal boundaries layer
        function pop_municipalities_1_simplified_1(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2" class="heritage-title"><strong>' + (feature.properties['NM_MUN'] !== null ? autolinker.link(String(feature.properties['NM_MUN']).replace(/'/g, '\'').toLocaleString()) : '') + '</strong></td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Estado</th>\
                        <td>' + (feature.properties['SIGLA_UF'] !== null ? autolinker.link(String(feature.properties['SIGLA_UF']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function(e) {
                addClassToPopupIfMedia(content, e.popup);
            });
            layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_municipalities_1_simplified_1_0() {
            return {
                pane: 'pane_municipalities_1_simplified_1',
                opacity: 1,
                color: 'rgba(140,140,140,0.7)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1, 
                fill: true,
                fillOpacity: 0.3,
                fillColor: 'rgba(236,242,246,0.3)',
                interactive: true,
            }
        }

        map.createPane('pane_municipalities_1_simplified_1');
        map.getPane('pane_municipalities_1_simplified_1').style.zIndex = 401;
        map.getPane('pane_municipalities_1_simplified_1').style['mix-blend-mode'] = 'normal';
        var layer_municipalities_1_simplified_1 = new L.geoJson(json_municipalities_1_simplified_1, {
            attribution: '',
            interactive: true,
            dataVar: 'json_municipalities_1_simplified_1',
            layerName: 'layer_municipalities_1_simplified_1',
            pane: 'pane_municipalities_1_simplified_1',
            onEachFeature: pop_municipalities_1_simplified_1,
            style: style_municipalities_1_simplified_1_0,
        });
        bounds_group.addLayer(layer_municipalities_1_simplified_1);
        map.addLayer(layer_municipalities_1_simplified_1);
        allLayers.municipal_boundaries = layer_municipalities_1_simplified_1;

        // Risk choropleth layer - NEW
        function pop_municipalities_with_combined_risk_simplified_2(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });

            const props = feature.properties;
            const heatIndex = props['heritage_heat_index'];
            const heatClass = props['heritage_heat_class'];

            // Determine color and label based on heat class
            let heatColor = '#95a5a6';
            let heatLabel = 'Nenhum';

            if (heatClass === 'low') {
                heatColor = '#f1c40f'; // Yellow
                heatLabel = 'Baixo';
            } else if (heatClass === 'high') {
                heatColor = '#e74c3c'; // Red
                heatLabel = 'Alto';
            }

            const popupContent = '<table>\
                    <tr>\
                        <td colspan="2" class="heritage-title"><strong>' + (props['NM_MUN'] ?? '') + '</strong></td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Estado</th>\
                        <td>' + (props['SIGLA_UF'] ?? '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">N√≠vel de Risco</th>\
                        <td class="risk-score" style="background-color: ' + heatColor + ' !important;">' + heatLabel + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Pontua√ß√£o de Risco</th>\
                        <td class="risk-score">' + (heatIndex !== null ? heatIndex.toFixed(2) : 'N/A') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Bens Culturais Protegidos</th>\
                        <td>' + (props['NUMPOINTS'] !== null ? props['NUMPOINTS'] : 0) + '</td>\
                    </tr>\
                </table>';

            const content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function(e) {
                addClassToPopupIfMedia(content, e.popup);
            });
            layer.bindPopup(content, { maxHeight: 400 });
        }

        // FIXED CHOROPLETH STYLING
        function style_municipalities_with_combined_risk_simplified_2_0(feature) {
            const index = feature.properties.heritage_heat_index;
          let fillColor = "#ffffff"; // fallback para dados ausentes

            if (index > 576) {
                fillColor = "#7a0403";
            } else if (index > 228.8) {
                fillColor = "#bd2002";
            } else if (index > 88.2) {
                fillColor = "#e94d0d";
            } else if (index > 31) {
                fillColor = "#fe8f29";
            } else if (index > 19) {
                fillColor = "#f2c93a";
            } else if (index > 13) {
                fillColor = "#c2f234";
            } else if (index > 8) {
                fillColor = "#7eff55";
            } else if (index > 5) {
                fillColor = "#2aefa1";
            } else if (index > 3) {
                fillColor = "#1fc9dd";
            } else if (index > 1) {
                fillColor = "#4390fe";
            } else if (index > 0) {
                fillColor = "#4455c4";
            } else {
                fillColor = "#30123b";
            }

            return {
                pane: 'pane_municipalities_with_combined_risk_simplified_2',
                opacity: 1,
                color: '#ffffff',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 0.5,
                fill: true,
                fillOpacity: 0.8,
                fillColor: fillColor,
                interactive: true,
            };
        }

        map.createPane('pane_municipalities_with_combined_risk_simplified_2');
        map.getPane('pane_municipalities_with_combined_risk_simplified_2').style.zIndex = 402;
        map.getPane('pane_municipalities_with_combined_risk_simplified_2').style['mix-blend-mode'] = 'normal';
        var layer_municipalities_with_combined_risk_simplified_2 = new L.geoJson(json_municipalities_with_combined_risk_simplified_2, {
            attribution: '',
            interactive: true,
            dataVar: 'json_municipalities_with_combined_risk_simplified_2',
            layerName: 'layer_municipalities_with_combined_risk_simplified_2',
            pane: 'pane_municipalities_with_combined_risk_simplified_2',
            onEachFeature: pop_municipalities_with_combined_risk_simplified_2,
            style: style_municipalities_with_combined_risk_simplified_2_0,
        });
        bounds_group.addLayer(layer_municipalities_with_combined_risk_simplified_2);
        map.addLayer(layer_municipalities_with_combined_risk_simplified_2);
        allLayers.municipal_risk = layer_municipalities_with_combined_risk_simplified_2;

        // Dam buffers layer
        function pop_snisb_dam_buffers_3(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2" class="heritage-title"><strong>' + (feature.properties['dam_name'] !== null ? autolinker.link(String(feature.properties['dam_name']).replace(/'/g, '\'').toLocaleString()) : '') + '</strong></td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Estado</th>\
                        <td>' + (feature.properties['state'] !== null ? autolinker.link(String(feature.properties['state']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Munic√≠pio</th>\
                        <td>' + (feature.properties['municipality'] !== null ? autolinker.link(String(feature.properties['municipality']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Finalidade</th>\
                        <td>' + (feature.properties['purpose'] !== null ? autolinker.link(String(feature.properties['purpose']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Categoria de Risco</th>\
                        <td class="risk-score">' + (feature.properties['risk_category'] !== null ? autolinker.link(String(feature.properties['risk_category']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Potencial de Dano</th>\
                        <td class="risk-score">' + (feature.properties['damage_potential'] !== null ? autolinker.link(String(feature.properties['damage_potential']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Risco ao Bem Cultural</th>\
                        <td class="risk-score">' + (feature.properties['heritage_risk_potential'] !== null ? autolinker.link(String(feature.properties['heritage_risk_potential']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function(e) {
                addClassToPopupIfMedia(content, e.popup);
            });
            layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_snisb_dam_buffers_3_0() {
            return {
                pane: 'pane_snisb_dam_buffers_3',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2.0, 
                fill: true,
                fillOpacity: 0.6,
                fillColor: 'rgba(231,113,72,0.6)',
                interactive: true,
            }
        }
        map.createPane('pane_snisb_dam_buffers_3');
        map.getPane('pane_snisb_dam_buffers_3').style.zIndex = 403;
        map.getPane('pane_snisb_dam_buffers_3').style['mix-blend-mode'] = 'normal';
        var layer_snisb_dam_buffers_3 = new L.geoJson(json_snisb_dam_buffers_3, {
            attribution: '',
            interactive: true,
            dataVar: 'json_snisb_dam_buffers_3',
            layerName: 'layer_snisb_dam_buffers_3',
            pane: 'pane_snisb_dam_buffers_3',
            onEachFeature: pop_snisb_dam_buffers_3,
            style: style_snisb_dam_buffers_3_0,
        });
        bounds_group.addLayer(layer_snisb_dam_buffers_3);
        map.addLayer(layer_snisb_dam_buffers_3);
        allLayers.dam_buffers = layer_snisb_dam_buffers_3;

        // FIXED HERITAGE SITES LAYER - Working with correct symbols and risk type filtering
        function pop_comprehensive_heritage_risk_4(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            
            // Enhanced heritage popup with 3 risk levels
            var riskScore = feature.properties['comprehensive_risk_score'];
            var riskLevel = 'Sem Risco';
            var riskColor = '#95a5a6';
            
            if (riskScore !== null && riskScore !== undefined && riskScore > 0) {
                if (riskScore <= 0.72) {
                    riskLevel = 'Risco M√©dio';
                    riskColor = '#f1c40f'; // Yellow
                } else if (riskScore <= 1.5) {
                    riskLevel = 'Risco Alto';
                    riskColor = '#e67e22'; // Orange
                } else {
                    riskLevel = 'Risco Muito Alto';
                    riskColor = '#e74c3c'; // Red
                }
            }
            
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2" class="heritage-title"><strong>' + (feature.properties['identificacao_bem'] !== null ? autolinker.link(String(feature.properties['identificacao_bem']).replace(/'/g, '\'').toLocaleString()) : 'S√≠tio de Bem Cultural') + '</strong></td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Natureza</th>\
                        <td>' + (feature.properties['ds_natureza'] !== null ? autolinker.link(String(feature.properties['ds_natureza']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Tipo de Prote√ß√£o</th>\
                        <td>' + (feature.properties['ds_tipo_protecao'] !== null ? autolinker.link(String(feature.properties['ds_tipo_protecao']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Munic√≠pio</th>\
                        <td>' + (feature.properties['municipality'] !== null ? autolinker.link(String(feature.properties['municipality']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Estado</th>\
                        <td>' + (feature.properties['uf'] !== null ? autolinker.link(String(feature.properties['uf']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Risco Geral</th>\
                        <td class="risk-score" style="background-color: ' + riskColor + ' !important;">' + riskLevel + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Pontua√ß√£o de Risco</th>\
                        <td class="risk-score">' + (riskScore !== null ? riskScore.toFixed(2) : 'N/A') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Desastre Tecnol√≥gico</th>\
                        <td>' + (feature.properties['dam_risk_score'] !== null ? feature.properties['dam_risk_score'].toFixed(2) : 'N/A') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Inc√™ndio Florestal</th>\
                        <td>' + (feature.properties['fire_risk_score'] !== null ? feature.properties['fire_risk_score'].toFixed(2) : 'N/A') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Risco CEMADEN (Geo/Hidro)</th>\
                        <td>' + (feature.properties['cemaden_risk_score'] !== null ? feature.properties['cemaden_risk_score'].toFixed(2) : 'N/A') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function(e) {
                addClassToPopupIfMedia(content, e.popup);
            });
            layer.bindPopup(content, { maxHeight: 400 });
        }

        // FIXED HERITAGE SYMBOLS - Simplified approach with 3 risk levels
        function style_comprehensive_heritage_risk_4_0(feature) {
            var nature = String(feature.properties['ds_natureza'] || '');
            var riskScore = feature.properties['comprehensive_risk_score'];
            
            // Determine risk color based on 3 levels
            var fillColor = '#8BC34A'; // Default light green for no risk
            if (riskScore !== null && riskScore !== undefined && riskScore > 0) {
                if (riskScore <= 0.72) {
                    fillColor = '#f1c40f'; // Yellow - Medium risk
                } else if (riskScore <= 1.5) {
                    fillColor = '#e67e22'; // Orange - High risk
                } else {
                    fillColor = '#e74c3c'; // Red - Very high risk
                }
            }
            
            // Handle both possible accent variations and encoding issues
            if (nature.includes('Im√≥vel') || nature.includes('Imovel')) {
                // Circles for immovable heritage
                return {
                    pane: 'pane_comprehensive_heritage_risk_4',
                    radius: 4.0,
                    opacity: 1,
                    color: fillColor,
                    dashArray: '',
                    lineCap: 'butt',
                    lineJoin: 'miter',
                    weight: 2.0,
                    fill: true,
                    fillOpacity: 0.8,
                    fillColor: fillColor,
                    interactive: true,
                }
            } else if (nature.includes('M√≥vel') || nature.includes('Movel')) {
                // Diamonds for movable heritage
                return {
                    pane: 'pane_comprehensive_heritage_risk_4',
                    shape: 'diamond',
                    radius: 4.0,
                    opacity: 1,
                    color: fillColor,
                    dashArray: '',
                    lineCap: 'butt',
                    lineJoin: 'miter',
                    weight: 2.0,
                    fill: true,
                    fillOpacity: 0.8,
                    fillColor: fillColor,
                    interactive: true,
                }
            } else {
                // Triangles for other heritage types
                return {
                    pane: 'pane_comprehensive_heritage_risk_4',
                    shape: 'triangle',
                    radius: 4.0,
                    opacity: 1,
                    color: fillColor,
                    dashArray: '',
                    lineCap: 'butt',
                    lineJoin: 'miter',
                    weight: 2.0,
                    fill: true,
                    fillOpacity: 0.8,
                    fillColor: fillColor,
                    interactive: true,
                }
            }
        }

        map.createPane('pane_comprehensive_heritage_risk_4');
        map.getPane('pane_comprehensive_heritage_risk_4').style.zIndex = 404;
        map.getPane('pane_comprehensive_heritage_risk_4').style['mix-blend-mode'] = 'normal';
        var layer_comprehensive_heritage_risk_4 = new L.geoJson(json_comprehensive_heritage_risk_4, {
            attribution: '',
            interactive: true,
            dataVar: 'json_comprehensive_heritage_risk_4',
            layerName: 'layer_comprehensive_heritage_risk_4',
            pane: 'pane_comprehensive_heritage_risk_4',
            onEachFeature: pop_comprehensive_heritage_risk_4,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.shapeMarker(latlng, style_comprehensive_heritage_risk_4_0(feature));
            },
        });
        bounds_group.addLayer(layer_comprehensive_heritage_risk_4);
        map.addLayer(layer_comprehensive_heritage_risk_4);
        allLayers.heritage = layer_comprehensive_heritage_risk_4;

        // Search functionality
        const url = {"Nominatim": "https://nominatim.openstreetmap.org/search?format=geojson&addressdetails=1&",
        "BAN": "https://api-adresse.data.gouv.fr/search/?"}
        var photonControl = L.control.photon({
            url: url["Nominatim"],
            feedbackLabel: '',
            position: 'topleft',
            includePosition: true,
            initial: true,
        }).addTo(map);
        photonControl._container.childNodes[0].style.borderRadius="10px"

        var x = null;
        var marker = null;
        var z = null;
        photonControl.on('selected', function(e) {
            console.log(photonControl.search.resultsContainer);
            if (x != null) {
                map.removeLayer(obj3.marker);
                map.removeLayer(x);
            }
            obj2.gcd = e.choice;
            x = L.geoJSON(obj2.gcd).addTo(map);
            var label = typeof obj2.gcd.properties.label === 'undefined' ? obj2.gcd.properties.display_name : obj2.gcd.properties.label;
            obj3.marker = L.marker(x.getLayers()[0].getLatLng()).bindPopup(label).addTo(map);
            map.setView(x.getLayers()[0].getLatLng(), 17);
            z = typeof e.choice.properties.label === 'undefined'? e.choice.properties.display_name : e.choice.properties.label;
            console.log(e);
            e.target.input.value = z;
        });

        var search = document.getElementsByClassName("leaflet-photon leaflet-control")[0];
        search.classList.add("leaflet-control-search")
        search.style.display = "flex";
        search.style.backgroundColor="rgba(255,255,255,0.5)" 

        var button = document.createElement("div");
        button.id = "gcd-button-control";
        button.className = "gcd-gl-btn fa fa-search search-button";

        search.insertBefore(button, search.firstChild);
        last = search.lastChild;
        last.style.display = "none";
        button.addEventListener("click", function (e) {
            if (last.style.display === "none") {
                last.style.display = "block";
            } else {
                last.style.display = "none";
            }
        });

        // Enhanced layer control with better legends - Portuguese version
        var overlaysTree = [
            {label: 'üèõÔ∏è Bens Culturais Materiais Protegidos<br /><table><tr><td style="text-align: center;"><div style="width:12px;height:12px;border-radius:50%;background:#f1c40f;display:inline-block;border:2px solid white;"></div></td><td>Bens Im√≥veis (C√≠rculo)</td></tr><tr><td style="text-align: center;"><div style="width:12px;height:12px;background:#f1c40f;display:inline-block;border:2px solid white;transform:rotate(45deg);"></div></td><td>Bens M√≥veis ou Integrados (Losango)</td></tr></table>', layer: layer_comprehensive_heritage_risk_4},
            {label: 'üèóÔ∏è Barragens Potencialmente Perigosas<br /><span style="color:#e77148;">Zonas de 5km ao Redor de Barragens</span>', layer: layer_snisb_dam_buffers_3},
            {label: 'üéØ Cloropl√©tico Municipal<br /><table><tr><td style="background:#f1c40f;width:20px;height:15px;"></td><td>Risco M√©dio</td></tr><tr><td style="background:#e67e22;width:20px;height:15px;"></td><td>Risco Alto</td></tr><tr><td style="background:#e74c3c;width:20px;height:15px;"></td><td>Risco Muito Alto</td></tr></table>', layer: layer_municipalities_with_combined_risk_simplified_2},
            {label: 'üó∫Ô∏è Limites Municipais', layer: layer_municipalities_1_simplified_1},
            {label: "üåç Mapa Base", layer: layer_OpenStreetMap_0},
        ]

        var lay = L.control.layers.tree(null, overlaysTree,{
            collapsed: true,
        });
        lay.addTo(map);

        // Check data status when all layers are loaded
        setTimeout(function() {
            checkDataStatus();
            document.getElementById('loadingIndicator').style.display = 'none';
        }, 2000);

        setBounds();
        
        // Final performance optimization
        setTimeout(function() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }, 5000);
        </script>
    </body>
</html>
